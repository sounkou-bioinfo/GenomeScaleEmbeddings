---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.path = "docs/README-"
)
```

# GenomeScaleEmbeddings

## Load the package

```{r}
library(GenomeScaleEmbeddings)
library(knitr)
```

## 1. Peek into remote parquet files

```{r}
# Use OpenRemoteParquetView to inspect the first few rows
OpenRemoteParquetView()
```

## 2. Copy remote parquet files into local DuckDB

```{r}
system.time(

CopyParquetToDuckDB(db_path = "local_embeddings.duckdb", overwrite = FALSE)
)
file.info("local_embeddings.duckdb")$size
```

## 3. Write embeddings to houba mmatrix

```{r}
system.time(

houba <- writeEmbeddingsHoubaFromDuckDB(dbPath = "local_embeddings.duckdb", 
overwrite = FALSE)
)
file.info("local_embeddings.houba")$size
```

## 4. Run PCA on houba mmatrix

```{r}
system.time(
  pca_res <- houbaPCA("local_embeddings.houba")
)
```

## 5. Get PCA scores

```{r}
pc_scores <- getPcaScores(pca_res)
object.size(pc_scores)
```

## 6. Plot PCA dimensions (PC1 vs PC2, colored by chromosome)

```{r}
plotPcaDims(pc_scores, houba$info, annotation_col = "chrom", dim1 = 1, dim2 = 2)
```

## 7. Print spatial correlations (PC1 vs genomic position, by chromosome)

```{r}
cor_table <- data.frame(
  Chromosome = unique(houba$info$chrom),
  Correlation = NA,
  P_value = NA
)
for (i in seq_along(cor_table$Chromosome)) {
  chr <- cor_table$Chromosome[i]
  idx <- houba$info$chrom == chr
  pos_numeric <- as.numeric(as.character(houba$info$pos[idx]))
  pc1 <- pc_scores[idx, 1]
  # Use differences
  d_pc1 <- diff(pc1)
  d_pos <- diff(pos_numeric)
  ct <- cor.test(d_pc1, d_pos, use = "complete.obs")
  cor_table$Correlation[i] <- ct$estimate
  cor_table$P_value[i] <- ct$p.value
}
kable(cor_table, digits = 4, caption = "Correlation (and p-value) between PC1 and Genomic Position differences by Chromosome")
```

---

- All file sizes are displayed after each step for transparency.
- Remote parquet files are previewed before local processing.
- For large datasets, consider subsampling for faster plotting.
- Use `overwrite = FALSE` for DuckDB and houba steps to avoid slow download and reuse existing files.
