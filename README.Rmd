---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.path = "docs/README-"
)
```

# GenomeScaleEmbeddings

We explore the SNP-level LLM embeddings from the paper "Incorporating LLM Embeddings for Variation Across the Human Genome".
We use `duckdb` to download the embeddings from huggingFace, save them in [`houba`](https://github.com/HervePerdry/houba) memory-mapped matrices, and use [`bigPCACpp`](https://github.com/fbertran/bigPCAcpp/) to perform PCA and some explorations.

## Load the packages

```{r}
library(GenomeScaleEmbeddings)
library(knitr)
library(httr2)
library(jsonlite)
library(dplyr)
library(ggplot2)
```

## 1. Peek into remote parquet files

```{r}
# Use OpenRemoteParquetView to inspect the first few rows
OpenRemoteParquetView()
```

## 2. Copy remote parquet files into local DuckDB

```{r}
system.time(

CopyParquetToDuckDB(db_path = "local_embeddings.duckdb", overwrite = FALSE)
)
file.info("local_embeddings.duckdb")$size
```

## 3. Write embeddings to houba mmatrix

```{r}
system.time(

houba <- writeEmbeddingsHoubaFromDuckDB(dbPath = "local_embeddings.duckdb", 
overwrite = FALSE)
)
houba
file.info("local_embeddings.houba")$size
```

## 4. Run PCA on houba mmatrix

```{r}
system.time(
  pca_res <- houbaPCA("local_embeddings.houba")
)
```

## 5. Get PCA scores

```{r}
pc_scores <- getPcaScores(pca_res)
object.size(pc_scores)
```

## 6. Plot PCA dimensions (colored by chromosome)

```{r}
plotPcaDims(pc_scores, houba$info, annotation_col = "chrom", dim1 = 1, dim2 = 2)
plotPcaDims(pc_scores, houba$info, annotation_col = "chrom", dim1 = 2, dim2 = 3)
plotPcaDims(pc_scores, houba$info, annotation_col = "chrom", dim1 = 3, dim2 = 4)
```

## 7. Annotate variants  from ensembl phenotype endpoint plot in the PCA spaces

```{r}
# Helper function to fetch and extract annotation
gen_phenotype_anno <- function(phenotype_term) {
  query <- utils::URLencode(paste0("https://rest.ensembl.org/phenotype/term/homo_sapiens/", phenotype_term))
  resp <- request(query) |>
    req_headers("Content-Type" = "application/json") |>
    req_perform()
  json <- resp_body_json(resp)
  lapply(json, function(x) {
    if (!is.null(x$Variation)) {
      data.frame(
        rsid = x$Variation,
        gen = if (!is.null(x$attributes$associated_gene)) x$attributes$associated_gene else NA,
        stringsAsFactors = FALSE
      )
    }
  }) |> bind_rows()
}

# Fetch annotation data frames using helper function
coffee_anno <- gen_phenotype_anno("coffee consumption")
preeclampsia_anno <- gen_phenotype_anno("preeclampsia")
ckd_anno <- gen_phenotype_anno("chronic kidney disease") |> rename(gen_ckd = gen)

# Merge PCA scores and houba info
plotDf <- cbind(pc_scores,houba$info)
names(plotDf)[1:15] <- paste0("PC",1:15)

# Annotate plotDf with coffee, preeclampsia, and CKD
plotDf <- plotDf |>
  left_join(coffee_anno, by = c("rsid" = "rsid")) |>
  left_join(preeclampsia_anno, by = c("rsid" = "rsid"), suffix = c("_coffee", "_preeclampsia")) |>
  left_join(ckd_anno, by = c("rsid" = "rsid"), suffix = c("", "_ckd"))

# Subset for coffee, preeclampsia, and CKD SNPs
coffee_snps <- subset(plotDf, !is.na(gen_coffee))|>
        unique()
preeclampsia_snps <- subset(plotDf, !is.na(gen_preeclampsia))|>
        unique()
ckd_snps <- subset(plotDf, !is.na(gen_ckd)) |>
        unique()

# Plot: coffee SNPs as circles, preeclampsia SNPs as triangles, CKD SNPs as squares
plot_pc_pair <- function(pc_x, pc_y, title) {
ggplot() +
  geom_point(data = coffee_snps, aes(x = .data[[pc_x]], y = .data[[pc_y]], color = .data[["gen_coffee"]]), shape = 16, size = 2, alpha = 0.7) +
  geom_point(data = preeclampsia_snps, aes(x = .data[[pc_x]], y = .data[[pc_y]], color = .data[["gen_preeclampsia"]]), shape = 17, size = 2, alpha = 0.7) +
  geom_point(data = ckd_snps, aes(x = .data[[pc_x]], y = .data[[pc_y]], color = .data[["gen_ckd"]]), shape = 15, size = 2, alpha = 0.7) +
  labs(title = title, x = pc_x, y = pc_y) +
  theme_minimal() +
  theme(legend.position = "none")
}
plot_pc_pair("PC1", "PC2", "PC1 vs PC2: coffee(circles), preeclampsia(triangles), CKD(squares) ")
plot_pc_pair("PC2", "PC3", "PC2 vs PC3: coffee(circles), preeclampsia(triangles), CKD(squares)")
plot_pc_pair("PC3", "PC4", "PC3 vs PC4: coffee(circles), preeclampsia(triangles), CKD(squares)")
```


## Notes

- All file sizes are displayed after each step for transparency.
- Remote parquet files are previewed before local processing.
- For large datasets, consider subsampling for faster plotting.
- Use `overwrite = FALSE` for DuckDB and houba steps to avoid slow download and reuse existing files.

## References

- The embeddings explored  here were published by the group in:
  - **Incorporating LLM Embeddings for Variation Across the Human Genome** ([arXiv:2509.20702v1](https://arxiv.org/html/2509.20702v1))
