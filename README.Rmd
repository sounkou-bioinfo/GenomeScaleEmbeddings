---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.path = "docs/README-"
)
```

# GenomeScaleEmbeddings

## Load the package

```{r}
library(GenomeScaleEmbeddings)
library(knitr)
library(httr2)
library(jsonlite)
library(dplyr)
library(ggplot2)
```

## 1. Peek into remote parquet files

```{r}
# Use OpenRemoteParquetView to inspect the first few rows
OpenRemoteParquetView()
```

## 2. Copy remote parquet files into local DuckDB

```{r}
system.time(

CopyParquetToDuckDB(db_path = "local_embeddings.duckdb", overwrite = FALSE)
)
file.info("local_embeddings.duckdb")$size
```

## 3. Write embeddings to houba mmatrix

```{r}
system.time(

houba <- writeEmbeddingsHoubaFromDuckDB(dbPath = "local_embeddings.duckdb", 
overwrite = FALSE)
)
houba
file.info("local_embeddings.houba")$size
```

## 4. Run PCA on houba mmatrix

```{r}
system.time(
  pca_res <- houbaPCA("local_embeddings.houba")
)
```

## 5. Get PCA scores

```{r}
pc_scores <- getPcaScores(pca_res)
object.size(pc_scores)
```

## 6. Plot PCA dimensions (PC1 vs PC2, colored by chromosome)

```{r}
plotPcaDims(pc_scores, houba$info, annotation_col = "chrom", dim1 = 1, dim2 = 2)
```

## 7. Annotate variants with coffee consumption GWAS and plot PC1 vs PC2 by gene

```{r}
# Fetch coffee consumption GWAS data
query <- utils::URLencode("https://rest.ensembl.org/phenotype/term/homo_sapiens/coffee consumption")
resp <- request(query) |>
  req_headers("Content-Type" = "application/json") |>
  req_perform()

coffee_json <- resp_body_json(resp)

# Extract rsid and gene annotation
coffee_anno <- lapply(coffee_json, function(x) {
  data.frame(
    rsid = x$Variation,
    gen = if (!is.null(x$attributes$associated_gene)) x$attributes$associated_gene else NA,
    stringsAsFactors = FALSE
  )
}) |> bind_rows()

# Merge
plotDf <- cbind(pc_scores,houba$info)
names(plotDf)[1:15] <- paste0("PC",1:15)
plotDf <- plotDf |>
  left_join(coffee_anno, by = c("rsid" = "rsid"))

# Set alpha = 0 for NA genes, 0.7 otherwise
plotDf$plot_alpha <- ifelse(is.na(plotDf$gen), 0, 0.7)

# Plot: coffee SNPs only, with gene annotation labels
coffee_snps <- subset(plotDf, !is.na(gen))

p <- ggplot(coffee_snps, aes(x = PC1, y = PC2, color = gen)) +
  geom_point(size = 2, alpha = 0.7) +
  labs(title = "PC1 vs PC2: coffee SNPs annotated by gene") +
  theme_minimal()

# Add text labels for gene annotation
p + geom_text(aes(label = gen), hjust = 0, vjust = 0, size = 2, check_overlap = TRUE)
```

---

- All file sizes are displayed after each step for transparency.
- Remote parquet files are previewed before local processing.
- For large datasets, consider subsampling for faster plotting.
- Use `overwrite = FALSE` for DuckDB and houba steps to avoid slow download and reuse existing files.
